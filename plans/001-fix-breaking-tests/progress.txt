## Progress Log

### 2026-02-07 — T10 & T11: Fix schema context assertions in catalog-builder.test.ts
- **Status**: DONE
- **File changed**: src/bidding/services/catalog-builder.test.ts
- **Root cause**: ENERGY_RESOURCE_SCHEMA_CTX and ENERGY_TRADE_OFFER_SCHEMA_CTX were consolidated to point at the unified EnergyTrade/v0.3/context.jsonld URL. Tests were asserting .toContain('EnergyResource') and .toContain('EnergyTradeOffer') which no longer appear in the URL path.
- **Fix**: Changed both assertions to .toContain('EnergyTrade'). Added @type assertions to verify the type names (EnergyResource, EnergyTradeOffer) are still correct — only the context URL changed, not the types. Added comments explaining the consolidation.
- **Tests renamed**:
  - 'should include EnergyResource context in items' → 'should reference the consolidated EnergyTrade schema context in item attributes'
  - 'should include EnergyTradeOffer context in offers' → 'should reference the consolidated EnergyTrade schema context in offer attributes'
- **Verification**: All 68 tests in catalog-builder pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: No npm lint script exists in package.json. Use `npx tsc --noEmit` for type checking. The remaining 23 tasks (T01-T09, T12-T25) are still pending.

### 2026-02-07 — T01: Fix "should retry on 5xx errors" in ledger-client.test.ts
- **Status**: DONE
- **File changed**: src/services/ledger-client.test.ts
- **Root cause (primary)**: `setup.ts` sets `LEDGER_RETRY_COUNT=1`, which is read at module load time as a top-level const. With retries=1, `withRetry()` runs only 1 iteration — on failure, `attempt === retries` (1===1) causes immediate throw with no retry. The test expected 2 calls (1 failure + 1 success) but got only 1.
- **Root cause (secondary)**: `jest.clearAllMocks()` in beforeEach does NOT clear mock implementation stacks (one-shot `mockResolvedValueOnce`). T01's unconsumed success mock leaked into the "should give up after max retries" test, causing it to receive a success instead of failure.
- **Root cause (tertiary)**: `jest.advanceTimersByTime()` is synchronous and doesn't flush microtasks, so the async `sleep()` in withRetry never resolves.
- **Fix**:
  1. Changed `jest.clearAllMocks()` → `jest.resetAllMocks()` in beforeEach to prevent cross-test mock leakage
  2. Used `jest.resetModules()` + dynamic `require('./ledger-client')` to get a fresh module instance with `LEDGER_RETRY_COUNT=3`
  3. Used `jest.advanceTimersByTimeAsync(1000)` to properly flush async timers
  4. Added AAA section comments and transactionId assertion
- **Test renamed**: 'should retry on 5xx errors' → 'should retry once and succeed after transient 5xx server error'
- **Side effect**: "should give up after max retries" now also passes (was failing due to mock leakage from T01)
- **Verification**: 18 of 19 tests pass. The 1 remaining failure is T02 ("should retry on connection errors") which is a separate task. TypeScript compiles cleanly.
- **Note for next person**: T02 needs the same `jest.resetModules()` + `jest.advanceTimersByTimeAsync` pattern as T01. The `resetAllMocks` change is already in place so mock leakage won't be an issue. Remaining tasks: T02-T09, T12-T25 (22 tasks).

### 2026-02-07 — T02: Fix "should retry on connection errors" in ledger-client.test.ts
- **Status**: DONE
- **File changed**: src/services/ledger-client.test.ts
- **Root cause**: Same as T01 — `LEDGER_RETRY_COUNT=1` (from setup.ts) means `withRetry()` runs only 1 iteration. On ECONNRESET, `isRetryable=true` but `attempt === retries` (1===1) causes immediate throw. The outer `catch` returns `null`. Test expected non-null → FAILED. Also used synchronous `jest.advanceTimersByTime` which doesn't flush the async `sleep()` promise.
- **Fix**:
  1. Used `jest.resetModules()` + dynamic `require('./ledger-client')` to get a fresh module with `LEDGER_RETRY_COUNT=3`
  2. Used `jest.advanceTimersByTimeAsync(1000)` to properly flush async timers
  3. Added proper assertions: `freshAxios.post` called exactly 2 times (1 ECONNRESET + 1 success), result is non-null, transactionId matches
  4. Added AAA section comments and cleanup restoring `LEDGER_RETRY_COUNT=1`
- **Test renamed**: 'should retry on connection errors' → 'should retry once and succeed after transient ECONNRESET connection error'
- **Verification**: All 19 tests pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: All ledger-client tests (T01, T02) are now fixed — 19/19 pass. Next up is T03 (hourly-market-analyzer.test.ts). Remaining tasks: T03-T09, T12-T25 (21 tasks).

### 2026-02-07 — T03: Fix "should include offers with unknown date" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: `createCompetitorOffer('unknown', 6.5)` calls `createValidityWindow('unknown')` which produces `{ start: 'unknownT08:00:00Z', end: 'unknownT17:00:00Z' }` — invalid date strings. `new Date('unknownT08:00:00Z').getTime()` returns NaN, and NaN comparisons in `timeRangesOverlap()` always return false. The offer passes the date filter (`offer.date === 'unknown'` is accepted) but fails the time overlap check. Then `return offer.date === date` → `'unknown' === '2026-01-28'` → false. So the unknown-date offer is excluded entirely.
- **Fix**: Overrode the validity_window on the 'unknown' date offer with a valid overlapping window (`09:00-12:00 UTC`) that properly overlaps the delivery window (`10:00-11:00 UTC`). Added a comment explaining that 'unknown' date offers need valid time windows to pass the overlap check.
- **Test renamed**: 'should include offers with unknown date' → 'should include unknown-date offers when their validity window overlaps the delivery window'
- **Verification**: T03 passes (14/18 in file). The 4 remaining failures are T04-T07 (separate tasks with same UTC time mismatch pattern). TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T04-T07 all have the same root cause — validity_window times written with IST in mind but stored as UTC, resulting in windows that don't actually overlap the delivery window (10:00-11:00 UTC). Each needs its validity_window adjusted to proper UTC times. The "mixed" test (T07) also has an offer labeled "non-overlapping" whose 10:00-11:00 UTC window actually matches the delivery window exactly. Remaining tasks: T04-T09, T12-T25 (20 tasks).

### 2026-02-07 — T05: Fix "should include offers that completely contain delivery window" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: The offer's validity window (`05:30-08:30 UTC`) did NOT contain the delivery window (`10:00-11:00 UTC`). There was zero overlap — `timeRangesOverlap(05:30, 08:30, 10:00, 11:00)` → `05:30 < 11:00 (true) && 10:00 < 08:30 (false)` → `false`. The times were likely written with IST offset in mind but stored as UTC.
- **Fix**: Changed validity window from `05:30-08:30 UTC` to `09:00-12:00 UTC` which truly contains the delivery window `10:00-11:00 UTC`. `timeRangesOverlap(09:00, 12:00, 10:00, 11:00)` → `09:00 < 11:00 (true) && 10:00 < 12:00 (true)` → `true`. Updated inline comments to describe the containment relationship in UTC.
- **Test renamed**: 'should include offers that completely contain delivery window' → 'should include offers whose validity window fully contains the delivery window'
- **Verification**: T05 passes (16/18 in file). The 2 remaining failures are T06 and T07 (separate tasks). TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T06 needs validity window changed from `06:45-07:15 UTC` to `10:15-10:45 UTC` (inside delivery 10:00-11:00 UTC). T07 has three sub-issues: offer #1 validity `06:00-08:00 UTC` doesn't overlap delivery, offer #3 (unknown date) has invalid NaN date strings from `createCompetitorOffer('unknown')`, and offer #4 labeled "non-overlapping" at `10:00-11:00 UTC` actually matches the delivery window exactly. Remaining tasks: T06-T09, T12-T25 (18 tasks).

### 2026-02-07 — T04: Fix "should include offers that overlap with delivery window" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: The offer's validity window (`06:00-07:00 UTC`) was entirely before the delivery window (`10:00-11:00 UTC`). The comments said "starts before delivery, ends during delivery" but the times were likely written with IST offset in mind and stored as UTC, so `timeRangesOverlap(06:00, 07:00, 10:00, 11:00)` → `06:00 < 11:00 (true) && 10:00 < 07:00 (false)` → `false`. Test expected 1 competitor but got 0.
- **Fix**: Changed validity window from `06:00-07:00 UTC` to `09:30-10:30 UTC` (starts before delivery start at 10:00, ends during delivery). Updated comments to correctly describe the UTC overlap semantics. `timeRangesOverlap(09:30, 10:30, 10:00, 11:00)` → `09:30 < 11:00 (true) && 10:00 < 10:30 (true)` → `true`.
- **Test renamed**: 'should include offers that overlap with delivery window' → 'should include offers whose validity window partially overlaps the start of the delivery window'
- **Verification**: T04 passes (15/18 in file). The 3 remaining failures are T05, T06, T07 (same UTC time mismatch pattern). TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T05 needs validity window changed from `05:30-08:30 UTC` to `09:00-12:00 UTC` (fully containing delivery 10:00-11:00). T06 needs validity window changed from `06:45-07:15 UTC` to `10:15-10:45 UTC` (inside delivery). T07 has three sub-issues: offer #1 validity doesn't overlap, offer #3 (unknown date) has invalid date strings, offer #4 labeled "non-overlapping" at 10:00-11:00 UTC actually matches delivery exactly. Remaining tasks: T05-T09, T12-T25 (19 tasks).

### 2026-02-07 — T06: Fix "should include offers where delivery window contains validity" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: The offer's validity window (`06:45-07:15 UTC`) was entirely before the delivery window (`10:00-11:00 UTC`), not inside it. `timeRangesOverlap(06:45, 07:15, 10:00, 11:00)` → `06:45 < 11:00 (true) && 10:00 < 07:15 (false)` → `false`. The times were likely written with IST offset in mind but stored as UTC.
- **Fix**: Changed validity window from `06:45-07:15 UTC` to `10:15-10:45 UTC` so the delivery window (`10:00-11:00 UTC`) fully contains the validity window. `timeRangesOverlap(10:15, 10:45, 10:00, 11:00)` → `10:15 < 11:00 (true) && 10:00 < 10:45 (true)` → `true`. Updated inline comments to describe the containment relationship in UTC.
- **Test renamed**: 'should include offers where delivery window contains validity' → 'should include offers whose validity window is fully contained within the delivery window'
- **Verification**: T06 passes (17/18 in file). The 1 remaining failure is T07 ("should analyze mixed valid and invalid offers") which is a separate task. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T07 ("should analyze mixed valid and invalid offers") has three sub-issues: (1) offer #1 validity `06:00-08:00 UTC` doesn't overlap delivery `10:00-11:00 UTC`, (2) offer #3 is `createCompetitorOffer('unknown', 8.0)` with default invalid NaN date strings, (3) offer #4 labeled "non-overlapping" has validity `10:00-11:00 UTC` which actually matches the delivery window exactly (timeRangesOverlap returns true). Remaining tasks: T07-T09, T12-T25 (17 tasks).

### 2026-02-07 — T07: Fix "should analyze mixed valid and invalid offers" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: Three sub-issues in the mixed scenario test:
  1. Offer #1 (price 7.5): validity `06:00-08:00 UTC` doesn't overlap delivery `10:00-11:00 UTC`. `timeRangesOverlap(06:00, 08:00, 10:00, 11:00)` → `06:00 < 11:00 (true) && 10:00 < 08:00 (false)` → `false`. Labeled "Valid" but actually excluded.
  2. Offer #3 (price 8.0, unknown date): `createCompetitorOffer('unknown', 8.0)` uses default `createValidityWindow('unknown')` which produces `unknownT08:00:00Z` / `unknownT17:00:00Z` — invalid dates → NaN in `timeRangesOverlap` → false. Labeled "Valid" but actually excluded.
  3. Offer #4 (price 5.0): validity `10:00-11:00 UTC` exactly matches delivery window `10:00-11:00 UTC`. `timeRangesOverlap(10:00, 11:00, 10:00, 11:00)` → `10:00 < 11:00 (true) && 10:00 < 11:00 (true)` → `true`. Labeled "non-overlapping" but actually INCLUDED.
  - Net result: only offer #4 passed (competitors_found=1, lowest=5.0) instead of expected (competitors_found=2, lowest=7.5).
- **Fix**:
  1. Offer #1: Changed validity to `09:30-11:30 UTC` which overlaps delivery `10:00-11:00 UTC`
  2. Offer #3: Provided explicit valid overlapping validity_window `09:00-12:00 UTC` instead of relying on broken default
  3. Offer #4: Changed validity to `04:00-05:00 UTC` which is truly before delivery (no overlap)
  4. Added `// Expected: INCLUDED` and `// Expected: EXCLUDED` comments with reasoning on each offer
- **Test renamed**: 'should analyze mixed valid and invalid offers' → 'should correctly filter mixed offers by date and time overlap, including only valid competitors'
- **Verification**: All 18 tests pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: All hourly-market-analyzer tests (T03-T07) are now fixed — 18/18 pass. Next up is T08 (notification/controller.test.ts). Remaining tasks: T08-T09, T12-T25 (16 tasks).

### 2026-02-07 — T08 & T09: Fix validation tests in notification/controller.test.ts
- **Status**: DONE
- **File changed**: src/notification/controller.test.ts
- **Root cause**: `sendSmsHandler` calls `sendSmsSchema.parse(req.body)` OUTSIDE the try/catch block (controller.ts:12). When validation fails, `.parse()` throws a `ZodError` that propagates as an unhandled exception. In production, Express's global error handler (app.ts:69-82) catches `ZodError` and returns 400 with structured `{ success: false, error: { code: 'VALIDATION_ERROR', ... } }`. But the test called `sendSmsHandler` directly with mock req/res objects, bypassing Express entirely — so the ZodError was unhandled and the 400 response was never sent.
- **Fix**: Replaced the direct handler invocation pattern with a mini Express app + supertest approach:
  1. Created `createTestApp()` that mounts `sendSmsHandler` on a real Express router
  2. Added the same ZodError error handler from `app.ts` (returns 400 with `VALIDATION_ERROR` code, field-level details)
  3. Used `supertest(app).post('/notification/sms').send(...)` for all tests
  4. Updated assertions to check the real response shape: `res.body.error.code === 'VALIDATION_ERROR'`, field-level error details
  5. Existing passing tests (200 success, 500 service error) also migrated to supertest for consistency
- **Tests renamed**:
  - T08: 'should return 400 if validation fails (invalid phone)' → 'should return 400 with validation details when phone format is invalid'
  - T09: 'should return 400 if validation fails (missing message)' → 'should return 400 with validation details when message field is missing'
- **Verification**: All 4 tests pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T08 and T09 shared the same root cause so they were fixed together. The supertest pattern is the right approach for any handler that relies on Express middleware (error handlers, auth middleware, etc.). Remaining tasks: T12-T25 (14 tasks). Next up is T12 (payment/routes.test.ts).

### 2026-02-07 — T12 (+ T14 side-effect): Fix "should successfully create an order and return payment link" in payment/routes.test.ts
- **Status**: DONE
- **File changed**: src/payment/routes.test.ts
- **Root cause**: Three issues preventing the test from passing:
  1. `validOrderData` was missing `sourceMeterId` and `messageId` fields, both required by the `paymentOrderSchema` Zod validation (routes.ts:58-59). This caused a 400 validation error before any business logic executed.
  2. The auth middleware mock only set `{ phone: "1234567890" }` on `req.user`, missing `userId`. Without `userId`, the route tries to look up the user via `db.collection("users").findOne({ phone })` (routes.ts:122-133), adding unnecessary complexity and potential failure points.
  3. `orderService.saveBuyerOrder()` was not mocked. The route calls it at line 175 after creating the Razorpay order and payment link. Without a mock, it would call the real implementation and fail.
- **Fix**:
  1. Added `sourceMeterId: "source-meter-456"` and `messageId: "msg-789"` to `validOrderData`
  2. Added `jest.mock("../services/order-service")` and typed `mockOrderService`
  3. Updated default auth middleware mock to include `userId: "aaaaaaaaaaaaaaaaaaaaaaaa"` (valid 24-char hex ObjectId)
  4. Updated DB `insertOne` assertion to match actual `txnBody` shape (includes `userPhone`, `userId`; does NOT include `meterId` which was incorrectly asserted before)
  5. Added assertion verifying `orderService.saveBuyerOrder` was called with correct transactionId and order data
- **Test renamed**: 'should successfully create an order and return payment link' → 'should create Razorpay order, save to DB, generate payment link, and save buyer order'
- **Side-effect fix (T14)**: The "should handle internal service errors" test also started passing because the shared `validOrderData` now passes Zod validation and the auth mock provides `userId`, allowing the request to reach the `createOrder` call which is mocked to reject.
- **Verification**: 9 of 10 tests pass in payment/routes.test.ts. The 1 remaining failure is T13 ("should use userPhone from body if not authenticated") which needs its own specific fix (mocking `findOne` on users collection to return a user with `_id`, mocking `saveBuyerOrder`). TypeScript compiles cleanly (tsc --noEmit). Full test suite: 414 pass, 12 fail (down from 14).
- **Note for next person**: T13 needs: (1) `mockCollection.findOne` to return `{ _id: new ObjectId('bbbbbbbbbbbbbbbbbbbbbbbb'), phone: '9876543210' }` when auth middleware doesn't set req.user, (2) `mockOrderService.saveBuyerOrder` mocked, (3) the test name renamed. The `validOrderData` and `orderService` mock are already in place from this commit. Remaining tasks: T13, T15-T25 (12 tasks).
