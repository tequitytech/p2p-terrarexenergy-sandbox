## Progress Log

### 2026-02-07 — T10 & T11: Fix schema context assertions in catalog-builder.test.ts
- **Status**: DONE
- **File changed**: src/bidding/services/catalog-builder.test.ts
- **Root cause**: ENERGY_RESOURCE_SCHEMA_CTX and ENERGY_TRADE_OFFER_SCHEMA_CTX were consolidated to point at the unified EnergyTrade/v0.3/context.jsonld URL. Tests were asserting .toContain('EnergyResource') and .toContain('EnergyTradeOffer') which no longer appear in the URL path.
- **Fix**: Changed both assertions to .toContain('EnergyTrade'). Added @type assertions to verify the type names (EnergyResource, EnergyTradeOffer) are still correct — only the context URL changed, not the types. Added comments explaining the consolidation.
- **Tests renamed**:
  - 'should include EnergyResource context in items' → 'should reference the consolidated EnergyTrade schema context in item attributes'
  - 'should include EnergyTradeOffer context in offers' → 'should reference the consolidated EnergyTrade schema context in offer attributes'
- **Verification**: All 68 tests in catalog-builder pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: No npm lint script exists in package.json. Use `npx tsc --noEmit` for type checking. The remaining 23 tasks (T01-T09, T12-T25) are still pending.

### 2026-02-07 — T01: Fix "should retry on 5xx errors" in ledger-client.test.ts
- **Status**: DONE
- **File changed**: src/services/ledger-client.test.ts
- **Root cause (primary)**: `setup.ts` sets `LEDGER_RETRY_COUNT=1`, which is read at module load time as a top-level const. With retries=1, `withRetry()` runs only 1 iteration — on failure, `attempt === retries` (1===1) causes immediate throw with no retry. The test expected 2 calls (1 failure + 1 success) but got only 1.
- **Root cause (secondary)**: `jest.clearAllMocks()` in beforeEach does NOT clear mock implementation stacks (one-shot `mockResolvedValueOnce`). T01's unconsumed success mock leaked into the "should give up after max retries" test, causing it to receive a success instead of failure.
- **Root cause (tertiary)**: `jest.advanceTimersByTime()` is synchronous and doesn't flush microtasks, so the async `sleep()` in withRetry never resolves.
- **Fix**:
  1. Changed `jest.clearAllMocks()` → `jest.resetAllMocks()` in beforeEach to prevent cross-test mock leakage
  2. Used `jest.resetModules()` + dynamic `require('./ledger-client')` to get a fresh module instance with `LEDGER_RETRY_COUNT=3`
  3. Used `jest.advanceTimersByTimeAsync(1000)` to properly flush async timers
  4. Added AAA section comments and transactionId assertion
- **Test renamed**: 'should retry on 5xx errors' → 'should retry once and succeed after transient 5xx server error'
- **Side effect**: "should give up after max retries" now also passes (was failing due to mock leakage from T01)
- **Verification**: 18 of 19 tests pass. The 1 remaining failure is T02 ("should retry on connection errors") which is a separate task. TypeScript compiles cleanly.
- **Note for next person**: T02 needs the same `jest.resetModules()` + `jest.advanceTimersByTimeAsync` pattern as T01. The `resetAllMocks` change is already in place so mock leakage won't be an issue. Remaining tasks: T02-T09, T12-T25 (22 tasks).

### 2026-02-07 — T02: Fix "should retry on connection errors" in ledger-client.test.ts
- **Status**: DONE
- **File changed**: src/services/ledger-client.test.ts
- **Root cause**: Same as T01 — `LEDGER_RETRY_COUNT=1` (from setup.ts) means `withRetry()` runs only 1 iteration. On ECONNRESET, `isRetryable=true` but `attempt === retries` (1===1) causes immediate throw. The outer `catch` returns `null`. Test expected non-null → FAILED. Also used synchronous `jest.advanceTimersByTime` which doesn't flush the async `sleep()` promise.
- **Fix**:
  1. Used `jest.resetModules()` + dynamic `require('./ledger-client')` to get a fresh module with `LEDGER_RETRY_COUNT=3`
  2. Used `jest.advanceTimersByTimeAsync(1000)` to properly flush async timers
  3. Added proper assertions: `freshAxios.post` called exactly 2 times (1 ECONNRESET + 1 success), result is non-null, transactionId matches
  4. Added AAA section comments and cleanup restoring `LEDGER_RETRY_COUNT=1`
- **Test renamed**: 'should retry on connection errors' → 'should retry once and succeed after transient ECONNRESET connection error'
- **Verification**: All 19 tests pass. TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: All ledger-client tests (T01, T02) are now fixed — 19/19 pass. Next up is T03 (hourly-market-analyzer.test.ts). Remaining tasks: T03-T09, T12-T25 (21 tasks).

### 2026-02-07 — T03: Fix "should include offers with unknown date" in hourly-market-analyzer.test.ts
- **Status**: DONE
- **File changed**: src/seller-bidding/services/hourly-market-analyzer.test.ts
- **Root cause**: `createCompetitorOffer('unknown', 6.5)` calls `createValidityWindow('unknown')` which produces `{ start: 'unknownT08:00:00Z', end: 'unknownT17:00:00Z' }` — invalid date strings. `new Date('unknownT08:00:00Z').getTime()` returns NaN, and NaN comparisons in `timeRangesOverlap()` always return false. The offer passes the date filter (`offer.date === 'unknown'` is accepted) but fails the time overlap check. Then `return offer.date === date` → `'unknown' === '2026-01-28'` → false. So the unknown-date offer is excluded entirely.
- **Fix**: Overrode the validity_window on the 'unknown' date offer with a valid overlapping window (`09:00-12:00 UTC`) that properly overlaps the delivery window (`10:00-11:00 UTC`). Added a comment explaining that 'unknown' date offers need valid time windows to pass the overlap check.
- **Test renamed**: 'should include offers with unknown date' → 'should include unknown-date offers when their validity window overlaps the delivery window'
- **Verification**: T03 passes (14/18 in file). The 4 remaining failures are T04-T07 (separate tasks with same UTC time mismatch pattern). TypeScript compiles cleanly (tsc --noEmit).
- **Note for next person**: T04-T07 all have the same root cause — validity_window times written with IST in mind but stored as UTC, resulting in windows that don't actually overlap the delivery window (10:00-11:00 UTC). Each needs its validity_window adjusted to proper UTC times. The "mixed" test (T07) also has an offer labeled "non-overlapping" whose 10:00-11:00 UTC window actually matches the delivery window exactly. Remaining tasks: T04-T09, T12-T25 (20 tasks).
