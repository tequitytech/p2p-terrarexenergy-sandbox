[
  {
    "id": "T01",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "Auth routes — login, verify-vc, /me, middleware",
    "description": "Create comprehensive tests for src/auth/routes.ts (420 LOC, zero test coverage). This is the gateway to all authenticated endpoints. Covers: login with valid/invalid credentials, JWT token signing/verification, authMiddleware (missing header, invalid token, valid token), validateBody middleware, verify-vc with external API mocking, and /me profile retrieval.",
    "testFile": "src/auth/routes.test.ts",
    "sourceFile": "src/auth/routes.ts",
    "testCases": [
      "POST /api/auth/login — should return token and user info for valid phone + PIN",
      "POST /api/auth/login — should return 401 for wrong PIN",
      "POST /api/auth/login — should return 401 for non-existent phone",
      "POST /api/auth/login — should return 400 for missing phone field",
      "POST /api/auth/login — should return 400 for invalid phone format (non-digits)",
      "POST /api/auth/login — should return 400 for PIN shorter than 6 digits",
      "POST /api/auth/login — should return 400 for PIN with non-numeric characters",
      "POST /api/auth/login — should include userId in token when user has _id",
      "signToken — should produce a valid JWT decodable by verifyToken",
      "verifyToken — should throw for expired or tampered token",
      "authMiddleware — should return 401 when Authorization header is missing",
      "authMiddleware — should return 401 when Authorization header does not start with Bearer",
      "authMiddleware — should return 401 with TOKEN_MALFORMED for invalid JWT",
      "authMiddleware — should set req.user and call next() for valid token",
      "validateBody — should call next() when body matches Zod schema",
      "validateBody — should return 400 with VALIDATION_ERROR when body fails schema",
      "POST /api/auth/verify-vc — should return 401 without auth token",
      "POST /api/auth/verify-vc — should return 400 with empty credentials array",
      "POST /api/auth/verify-vc — should return 400 when credential id does not start with did:rcw:",
      "POST /api/auth/verify-vc — should return 400 when credential type array missing VerifiableCredential",
      "POST /api/auth/verify-vc — should return 404 when user not found",
      "POST /api/auth/verify-vc — should verify credential via external API, store profile, and set vcVerified",
      "POST /api/auth/verify-vc — should map issuerName to utilityId in stored profile",
      "POST /api/auth/verify-vc — should extract meterNumber into user.meters array",
      "POST /api/auth/verify-vc — should add failed entry when external API returns status !== ISSUED",
      "POST /api/auth/verify-vc — should add failed entry when revoked/expired/proof checks fail",
      "POST /api/auth/verify-vc — should return 503 when VC service times out",
      "POST /api/auth/verify-vc — should return 503 when VC service returns 5xx",
      "POST /api/auth/verify-vc — should add failed entry when VC service returns 404",
      "POST /api/auth/verify-vc — should verify multiple credentials in single request",
      "GET /api/auth/me — should return 401 without auth token",
      "GET /api/auth/me — should return 404 when user not found by userId",
      "GET /api/auth/me — should return user profile with role=prosumer when generationProfile exists",
      "GET /api/auth/me — should return user profile with role=consumer when no generationProfile",
      "GET /api/auth/me — should return all profile fields including meters and memberSince"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "jest.mock('axios') — mock external VC verification API calls",
      "jest.mock('jsonwebtoken') — NOT mocked; use real JWT for integration-level auth tests",
      "Seed users via direct db.collection('users').insertOne() with known ObjectIds"
    ],
    "verification": "npm test -- --testPathPattern='auth/routes' && npm run build"
  },
  {
    "id": "T02",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "Utility functions — calculatePrice, normalizeDomain, parseError, calculateTotalAmount",
    "description": "Create unit tests for src/utils/index.ts (151 LOC, zero test coverage). calculatePrice is used in every quote with 4 pricing models (PER_KWH, FIXED, SUBSCRIPTION, TIME_OF_DAY). normalizeDomain strips port numbers. parseError handles Axios errors vs regular errors. calculateTotalAmount extracts nested Beckn offer prices.",
    "testFile": "src/utils/index.test.ts",
    "sourceFile": "src/utils/index.ts",
    "testCases": [
      "normalizeDomain — should return domain unchanged when no port",
      "normalizeDomain — should strip port number from domain",
      "normalizeDomain — should strip multi-segment port (e.g., :8082.1.0)",
      "normalizeDomain — should return empty/falsy domain as-is",
      "parseError — should return null for non-Error input",
      "parseError — should return message string for plain Error",
      "parseError — should extract ONIX error.message from AxiosError response.data.message.error.message",
      "parseError — should fall back to error.message when AxiosError has no ONIX error structure",
      "calculatePrice PER_KWH — should multiply basePrice × quantity",
      "calculatePrice PER_KWH — should add wheelingCharges to energy cost",
      "calculatePrice PER_KWH — should default wheelingCharges to 0",
      "calculatePrice FIXED — should return basePrice regardless of quantity",
      "calculatePrice FIXED — should add wheelingCharges to fixed price",
      "calculatePrice SUBSCRIPTION — should return basePrice regardless of quantity",
      "calculatePrice TIME_OF_DAY — should use applicable rate for current hour",
      "calculatePrice TIME_OF_DAY — should fall back to basePrice when no rate matches current hour",
      "calculatePrice TIME_OF_DAY — should fall back to basePrice when timeOfDayRates is undefined",
      "calculatePrice TIME_OF_DAY — should fall back to basePrice when timeOfDayRates is empty array",
      "calculatePrice default — should use PER_KWH formula for unknown pricing model",
      "calculateTotalAmount — should extract schema:price from offer and calculate total",
      "calculateTotalAmount — should use PER_KWH as default pricing model",
      "calculateTotalAmount — should include wheelingCharges from offerAttributes",
      "calculateTotalAmount — should handle offer with timeOfDayRates pricing model",
      "calculateTotalAmount — should handle offer with FIXED pricing model",
      "calculateTotalAmount — should handle missing offerAttributes gracefully"
    ],
    "mocksNeeded": [
      "No DB mocks needed — pure utility functions",
      "For TIME_OF_DAY tests: jest.useFakeTimers() to control new Date().getUTCHours()",
      "For parseError AxiosError tests: create mock AxiosError with isAxiosError() returning true"
    ],
    "verification": "npm test -- --testPathPattern='utils/index' && npm run build"
  },
  {
    "id": "T03",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "Payment service — Razorpay createOrder, createPaymentLink, verifyPayment, getPayment",
    "description": "Create tests for src/services/payment-service.ts (150 LOC, zero test coverage). Financial module — tests must verify amount conversion to paise (×100), Razorpay SDK method calls, payment signature verification via validatePaymentVerification, DB status updates on valid signatures, and getPayment retrieval.",
    "testFile": "src/services/payment-service.test.ts",
    "sourceFile": "src/services/payment-service.ts",
    "testCases": [
      "createOrder — should convert amount to paise (amount × 100) and call razorpay.orders.create",
      "createOrder — should floor paise amount (no fractional paise)",
      "createOrder — should pass currency, receipt, and notes to razorpay.orders.create",
      "createOrder — should propagate error when razorpay.orders.create fails",
      "createPaymentLink — should call razorpay.paymentLink.create with correct params",
      "createPaymentLink — should set accept_partial=false and callback_url",
      "createPaymentLink — should return AxiosError response data instead of throwing for Axios errors",
      "createPaymentLink — should propagate non-Axios errors",
      "verifyPayment — should return true and update DB when signature is valid",
      "verifyPayment — should map razorpayPaymentLinkStatus to PaymentStatus enum",
      "verifyPayment — should use PaymentStatus.FAILED for unknown status strings",
      "verifyPayment — should return false when signature verification fails",
      "verifyPayment — should throw when RAZORPAY_KEY_SECRET is not configured",
      "getPayment — should return payment document by orderId",
      "getPayment — should return null when orderId not found"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "jest.mock('./razorpay') — mock razorpay instance and rzp_key_secret",
      "jest.mock('razorpay/dist/utils/razorpay-utils') — mock validatePaymentVerification"
    ],
    "verification": "npm test -- --testPathPattern='services/payment-service' && npm run build"
  },
  {
    "id": "T04",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "BAP webhook controller — on_select/init/confirm/status callbacks",
    "description": "Create tests for src/bap-webhook/controller.ts (218 LOC, zero test coverage). The BAP webhook handles all on_* callbacks from BPP. Critical: on_confirm creates settlement records, saves buyer orders, and sends email notifications. All handlers resolve pending transactions for sync API. Tests use direct handler invocation with mockRequest/mockResponse.",
    "testFile": "src/bap-webhook/controller.test.ts",
    "sourceFile": "src/bap-webhook/controller.ts",
    "testCases": [
      "onSelect — should return ACK response with status 200",
      "onSelect — should resolve pending transaction when transactionId exists",
      "onSelect — should not resolve when no pending transaction exists",
      "onSelect — should handle error in body gracefully (still ACK)",
      "onInit — should return ACK response with status 200",
      "onInit — should resolve pending transaction when transactionId exists",
      "onInit — should pass error field through to resolved transaction data",
      "onConfirm — should return ACK response with status 200",
      "onConfirm — should resolve pending transaction when transactionId exists",
      "onConfirm — should create BUYER settlement record with correct quantity",
      "onConfirm — should calculate totalQuantity from multiple orderItems",
      "onConfirm — should extract sellerPlatformId from context.bpp_id",
      "onConfirm — should extract sellerDiscomId from orderAttributes.utilityIdSeller",
      "onConfirm — should call orderService.saveBuyerOrder with transactionId and order data",
      "onConfirm — should call notificationService.sendOrderConfirmation",
      "onConfirm — should not create settlement when error is present in body",
      "onConfirm — should not create settlement when message.order is missing",
      "onConfirm — should handle settlement creation failure gracefully (still ACK)",
      "onStatus — should return ACK response with status 200",
      "onStatus — should resolve pending transaction when transactionId exists",
      "onCancel — should return ACK and resolve pending transaction",
      "onUpdate — should return ACK and resolve pending transaction"
    ],
    "mocksNeeded": [
      "jest.mock('../services/transaction-store') — mock resolvePendingTransaction, hasPendingTransaction",
      "jest.mock('../services/settlement-store') — mock settlementStore.createSettlement",
      "jest.mock('../services/order-service') — mock orderService.saveBuyerOrder",
      "jest.mock('../services/notification-service') — mock notificationService.sendOrderConfirmation",
      "Use mockRequest/mockResponse from test-utils for handler invocation"
    ],
    "verification": "npm test -- --testPathPattern='bap-webhook/controller' && npm run build"
  },
  {
    "id": "T05",
    "status": "done",
    "priority": "P0",
    "category": "expand-tests",
    "title": "Expand order-service — updateBuyerOrderStatus, getSellerOrders, updateSellerOrderStatus, getBuyerOrder",
    "description": "Expand src/services/order-service.test.ts (3 existing tests) to cover remaining methods. Currently tested: saveBuyerOrder, getBuyerOrders, getCombinedOrders. Missing: updateBuyerOrderStatus edge cases, getBuyerOrder (single), getSellerOrders, updateSellerOrderStatus, getCombinedOrders sort order.",
    "testFile": "src/services/order-service.test.ts",
    "sourceFile": "src/services/order-service.ts",
    "testCases": [
      "getBuyerOrder — should return single buyer order by transactionId",
      "getBuyerOrder — should return null when transactionId not found",
      "updateBuyerOrderStatus — should warn when no matching order exists (matchedCount=0)",
      "updateBuyerOrderStatus — should merge additional update fields with status",
      "getSellerOrders — should return orders from 'orders' collection with type=SELLER",
      "getSellerOrders — should return empty array when no seller orders exist",
      "getSellerOrders — should sort by createdAt descending",
      "updateSellerOrderStatus — should update both orderStatus and status fields",
      "updateSellerOrderStatus — should warn when no matching seller order exists",
      "updateSellerOrderStatus — should merge additional update fields",
      "getCombinedOrders — should sort combined orders by createdAt descending",
      "getCombinedOrders — should return empty array when user has no orders",
      "saveBuyerOrder — should upsert (update if same transactionId exists)",
      "saveBuyerOrder — should set default status to INITIATED when not provided"
    ],
    "mocksNeeded": [
      "Uses existing test DB mock pattern from the file",
      "No additional mocks needed — pure DB operations"
    ],
    "verification": "npm test -- --testPathPattern='services/order-service' && npm run build"
  },
  {
    "id": "T06",
    "status": "done",
    "priority": "P0",
    "category": "expand-tests",
    "title": "Expand catalog-store — earnings, totalSold, availableInventory, beneficiaryDonations, publishedItems, getSellerUserIdForItem",
    "description": "Expand src/services/catalog-store.test.ts to cover complex aggregation pipelines and helper methods that have zero test coverage. getSellerEarnings uses a 4-stage MongoDB pipeline. getPublishedItems uses $lookup across items→offers. getSellerUserIdForItem has a 3-level fallback chain (item.userId → catalog.userId → meterId lookup).",
    "testFile": "src/services/catalog-store.test.ts",
    "sourceFile": "src/services/catalog-store.ts",
    "testCases": [
      "getSellerEarnings — should calculate total earnings from confirmed/scheduled orders",
      "getSellerEarnings — should return 0 when no matching orders exist",
      "getSellerEarnings — should filter by confirmedAt date range when from/to provided",
      "getSellerEarnings — should round to 2 decimal places",
      "getSellerTotalSold — should sum unitQuantity across confirmed/scheduled orders",
      "getSellerTotalSold — should return 0 when no matching orders exist",
      "getSellerAvailableInventory — should sum availableQuantity from items collection",
      "getSellerAvailableInventory — should return 0 when no items for seller",
      "getBeneficiaryDonations — should calculate donations to verified beneficiaries only",
      "getBeneficiaryDonations — should return 0 when no beneficiary orders exist",
      "getPublishedItems — should return active items with matching offers that have quantity > 0",
      "getPublishedItems — should exclude items with no matching offers",
      "getPublishedItems — should exclude items where all offers have unitQuantity = 0",
      "getPublishedItems — should use $lookup to join items with offers by beckn:id",
      "getSellerUserIdForItem — should return item.userId when present",
      "getSellerUserIdForItem — should fall back to catalog.userId when item.userId is null",
      "getSellerUserIdForItem — should fall back to meterId user lookup when catalog.userId is null",
      "getSellerUserIdForItem — should return null when item not found",
      "buildCatalogForPublish — should rebuild catalog with items and offers, stripping MongoDB fields",
      "buildCatalogForPublish — should throw when catalog not found",
      "reduceOfferInventory — should decrement unitQuantity by amount",
      "reduceOfferInventory — should throw when insufficient inventory",
      "getOffersByItemId — should return offers where beckn:items contains the itemId"
    ],
    "mocksNeeded": [
      "Uses existing test DB mock pattern from the file",
      "Seed orders collection with beckn order structure for earnings/totalSold tests",
      "Seed users collection with isVerifiedBeneficiary=true for donation tests",
      "Seed items + offers with beckn:isActive and proper beckn:id links for publishedItems tests"
    ],
    "verification": "npm test -- --testPathPattern='services/catalog-store' && npm run build"
  },
  {
    "id": "T07",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "Settlement poller — pollOnce, refreshSettlement, triggerOnSettle, startPolling, stopPolling",
    "description": "Create tests for src/services/settlement-poller.ts (267 LOC, zero test coverage). Background polling service that queries the ledger for settlement updates. pollOnce iterates pending settlements, queries ledger, updates settlement store, syncs order status, and triggers on_settle callbacks. Uses module-level state (pollInterval, isPolling, lastPollResult) that needs careful test isolation.",
    "testFile": "src/services/settlement-poller.test.ts",
    "sourceFile": "src/services/settlement-poller.ts",
    "testCases": [
      "pollOnce — should return empty result when no pending settlements",
      "pollOnce — should query ledger for each pending settlement",
      "pollOnce — should update settlement when ledger record found",
      "pollOnce — should increment settlementsUpdated counter for each update",
      "pollOnce — should add transactionId to newlySettled when status transitions to SETTLED",
      "pollOnce — should call triggerOnSettle for newly settled transactions",
      "pollOnce — should call markOnSettleNotified after successful callback",
      "pollOnce — should not trigger callback when onSettleNotified is already true",
      "pollOnce — should update buyer order status to DELIVERED when settlement is SETTLED and role=BUYER",
      "pollOnce — should update seller order status to DELIVERED when settlement is SETTLED and role=SELLER",
      "pollOnce — should catch and record errors per settlement without stopping the loop",
      "pollOnce — should skip when already polling (isPolling guard)",
      "pollOnce — should reset isPolling flag even on error (finally block)",
      "triggerOnSettle — should POST settlement data to ON_SETTLE_CALLBACK_URL",
      "triggerOnSettle — should include context with action=on_settle and settlement details",
      "triggerOnSettle — should skip when ON_SETTLE_CALLBACK_URL is not configured",
      "triggerOnSettle — should catch and log callback errors without throwing",
      "refreshSettlement — should query ledger and update settlement store",
      "refreshSettlement — should trigger on_settle callback for newly settled",
      "refreshSettlement — should return null when no ledger record found",
      "refreshSettlement — should not trigger callback when already notified",
      "startPolling — should not start when ENABLE_SETTLEMENT_POLLING=false",
      "stopPolling — should clear the interval",
      "getPollingStatus — should return current polling state"
    ],
    "mocksNeeded": [
      "jest.mock('../services/ledger-client') — mock ledgerClient.queryTradeByTransaction",
      "jest.mock('../services/settlement-store') — mock getPendingSettlements, updateFromLedger, markOnSettleNotified",
      "jest.mock('../services/order-service') — mock updateBuyerOrderStatus, updateSellerOrderStatus",
      "jest.mock('../services/catalog-store') — mock getOrderByTransactionId",
      "jest.mock('axios') — mock POST for on_settle callback",
      "jest.useFakeTimers() for startPolling/stopPolling tests",
      "Set process.env.ON_SETTLE_CALLBACK_URL and process.env.DISCOM_ID before import"
    ],
    "verification": "npm test -- --testPathPattern='services/settlement-poller' && npm run build"
  },
  {
    "id": "T08",
    "status": "done",
    "priority": "P0",
    "category": "new-tests",
    "title": "Notification service — sendOrderConfirmation email flow",
    "description": "Create tests for src/services/notification-service.ts (59 LOC, zero test coverage). Sends order confirmation emails to buyers. Looks up buyer by profile ID (consumptionProfile.id, utilityCustomer.did, or phone fallback), extracts order details, and calls emailService.sendEmail.",
    "testFile": "src/services/notification-service.test.ts",
    "sourceFile": "src/services/notification-service.ts",
    "testCases": [
      "sendOrderConfirmation — should send email to buyer when user has verified email",
      "sendOrderConfirmation — should include transactionId, totalQuantity, seller, and amount in email body",
      "sendOrderConfirmation — should find user by consumptionProfile.id",
      "sendOrderConfirmation — should find user by utilityCustomer.did as fallback",
      "sendOrderConfirmation — should find user by phone as last fallback",
      "sendOrderConfirmation — should skip when no buyer ID in order (beckn:buyer.beckn:id missing)",
      "sendOrderConfirmation — should skip when user not found in DB",
      "sendOrderConfirmation — should skip when user has no email",
      "sendOrderConfirmation — should calculate totalQuantity from multiple orderItems",
      "sendOrderConfirmation — should not throw on emailService error (catch and log)"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "jest.mock('./email-service') — mock emailService.sendEmail",
      "Seed users with email, profiles.consumptionProfile.id, profiles.utilityCustomer.did"
    ],
    "verification": "npm test -- --testPathPattern='services/notification-service' && npm run build"
  },
  {
    "id": "T09",
    "status": "done",
    "priority": "P1",
    "category": "expand-tests",
    "title": "Expand webhook controller — onSelect inventory check, onConfirm settlement + republish",
    "description": "Expand src/webhook/controller.test.ts to cover critical business logic gaps. The existing tests cover calculateDeliveryProgress and validateContext helpers but miss: onSelect inventory check and INSUFFICIENT_INVENTORY error callback, onConfirm inventory pre-check, offer reduction, catalog republish, and settlement creation.",
    "testFile": "src/webhook/controller.test.ts",
    "sourceFile": "src/webhook/controller.ts",
    "testCases": [
      "onSelect — should send INSUFFICIENT_INVENTORY error when requested > available quantity",
      "onConfirm — should create settlement record with totalQuantity from orderItems",
      "onConfirm — should send INSUFFICIENT_INVENTORY error when pre-check fails"
    ],
    "mocksNeeded": [
      "jest.mock('../services/catalog-store') — mock getItem, getOffer, reduceOfferInventory, getOffersByItemId, saveOrder, buildCatalogForPublish",
      "jest.mock('../services/settlement-store') — mock createSettlement",
      "jest.mock('../services/payment-service') — mock createOrder, createPaymentLink",
      "jest.mock('axios') — mock callback POST calls",
      "Use mockRequest/mockResponse for handler invocation"
    ],
    "verification": "npm test -- --testPathPattern='webhook/controller' && npm run build"
  },
  {
    "id": "T10",
    "status": "done",
    "priority": "P1",
    "category": "expand-tests",
    "title": "Expand sync-api controller — catalog-based select, select-based init, init-based confirm with inter-discom validation",
    "description": "Expand src/sync-api/controller.test.ts to cover the simplified API formats. The existing tests cover raw beckn format but miss: catalog-based select (transformCatalogToOrder), select-based init (transformSelectToInit + wheeling charges), init-based confirm (transformInitToConfirm + inter-discom utilityId validation), isAckResponse string parsing, and syncHealth.",
    "testFile": "src/sync-api/controller.test.ts",
    "sourceFile": "src/sync-api/controller.ts",
    "testCases": [
      "syncSelect — should transform catalog-based input to beckn format",
      "syncSelect — should return 401 when catalog-based request has no userId",
      "syncSelect — should return 403 when user has no buyer profile (NO_BUYER_PROFILE)",
      "syncSelect — should return 400 for invalid catalog-based schema",
      "syncSelect — should return 400 with BUSINESS_ERROR when response contains error",
      "syncInit — should transform select-based input to beckn init with fulfillment + payment",
      "syncInit — should calculate total amount with wheeling charges",
      "syncInit — should return 401 when select-based request has no userId",
      "syncInit — should return 400 for invalid select-based schema",
      "syncConfirm — should transform init-based input to beckn confirm",
      "syncConfirm — should return 400 when utilityIdBuyer is missing for inter-discom",
      "syncConfirm — should return 400 when utilityIdSeller is missing for inter-discom",
      "syncConfirm — should return 400 when utilityIdBuyer is empty string",
      "isAckResponse — should detect ACK from JSON object",
      "isAckResponse — should detect NACK from JSON object",
      "isAckResponse — should detect ACK from string response (malformed proxy)",
      "isAckResponse — should detect NACK from string response",
      "isAckResponse — should return false for unknown format",
      "syncHealth — should return OK status and pending transaction count",
      "validateSelect — should pass through catalog-based format without standard validation",
      "validateInit — should pass through select-based format without standard validation"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock for extractBuyerDetails",
      "jest.mock('../services/transaction-store') — mock createPendingTransaction, cancelPendingTransaction, getPendingCount",
      "jest.mock('axios') — mock ONIX BAP calls",
      "jest.mock('../auth/routes') — authMiddleware pass-through with userId",
      "Seed user with consumptionProfile for extractBuyerDetails"
    ],
    "verification": "npm test -- --testPathPattern='sync-api/controller' && npm run build"
  },
  {
    "id": "T11",
    "status": "done",
    "priority": "P1",
    "category": "expand-tests",
    "title": "Expand notification controller — sendEmailHandler coverage",
    "description": "Expand src/notification/controller.test.ts (4 existing tests cover sendSmsHandler) to add tests for sendEmailHandler if it exists, or add more edge cases for SMS validation.",
    "testFile": "src/notification/controller.test.ts",
    "sourceFile": "src/notification/controller.ts",
    "testCases": [
      "sendSmsHandler — should return 400 when phone is empty string",
      "sendSmsHandler — should return 400 when request body has no fields",
      "sendSmsHandler — should accept valid international phone formats",
      "sendSmsHandler — should return specific validation errors for each invalid field",
      "sendEmailHandler — should return 200 on successful email send",
      "sendEmailHandler — should return 500 when emailService.sendEmail returns false",
      "sendEmailHandler — should return 500 when emailService throws an error",
      "sendEmailHandler — should return 400 when 'to' field is missing",
      "sendEmailHandler — should return 400 when 'to' is not a valid email",
      "sendEmailHandler — should return 400 when subject is empty string",
      "sendEmailHandler — should return 400 when body is empty string",
      "sendEmailHandler — should return 400 when all fields are missing",
      "sendEmailHandler — should return 400 when subject field is missing",
      "sendEmailHandler — should return 400 when body field is missing"
    ],
    "mocksNeeded": [
      "Uses existing mock pattern from the file (jest.mock smsService)",
      "Uses existing createTestApp() pattern with ZodError handler"
    ],
    "verification": "npm test -- --testPathPattern='notification/controller' && npm run build"
  },
  {
    "id": "T12",
    "status": "done",
    "priority": "P1",
    "category": "expand-tests",
    "title": "Expand payment routes — callback order update, verify payment signature, edge cases",
    "description": "Expand src/payment/routes.test.ts to cover the payment callback route (GET /api/payment-callback), which verifies the Razorpay signature, updates order status, and redirects. Also cover missing edge cases in existing create order tests.",
    "testFile": "src/payment/routes.test.ts",
    "sourceFile": "src/payment/routes.ts",
    "testCases": [
      "GET /api/payment-callback — should verify signature and update order status to PAID",
      "GET /api/payment-callback — should redirect to success URL after verification",
      "GET /api/payment-callback — should handle invalid signature (verifyPayment returns false)",
      "POST /api/payment/create-order — should return 400 when amount is zero or negative",
      "POST /api/payment/create-order — should return 400 when required fields missing (no sourceMeterId)"
    ],
    "mocksNeeded": [
      "Uses existing mock pattern from the file",
      "jest.mock('../services/payment-service') — mock verifyPayment",
      "jest.mock('../services/order-service') — mock updateBuyerOrderStatus"
    ],
    "verification": "npm test -- --testPathPattern='payment/routes' && npm run build"
  },
  {
    "id": "T13",
    "status": "done",
    "priority": "P2",
    "category": "new-tests",
    "title": "Dashboard routes — GET /api/dashboard/stats",
    "description": "Create tests for src/dashboard/routes.ts (53 LOC, zero test coverage). Single endpoint that aggregates seller stats (totalEnergySold, availableEnergy, totalEarnings, donatedEnergy) by calling 4 catalogStore methods in parallel.",
    "testFile": "src/dashboard/routes.test.ts",
    "sourceFile": "src/dashboard/routes.ts",
    "testCases": [
      "GET /api/dashboard/stats — should return 400 when sellerId query param is missing",
      "GET /api/dashboard/stats — should return aggregated stats for valid sellerId",
      "GET /api/dashboard/stats — should return all values rounded to 2 decimal places",
      "GET /api/dashboard/stats — should return zeros when seller has no data",
      "GET /api/dashboard/stats — should return 500 when catalogStore throws"
    ],
    "mocksNeeded": [
      "jest.mock('../services/catalog-store') — mock getSellerEarnings, getSellerTotalSold, getSellerAvailableInventory, getBeneficiaryDonations",
      "Use supertest with Express app mounting dashboardRoutes()"
    ],
    "verification": "npm test -- --testPathPattern='dashboard/routes' && npm run build"
  },
  {
    "id": "T14",
    "status": "done",
    "priority": "P2",
    "category": "new-tests",
    "title": "Orders routes — buyer/seller/combined listing",
    "description": "Create tests for src/orders/routes.ts (126 LOC, zero test coverage). Three authenticated endpoints that list buyer orders, seller orders, and combined orders. All require authMiddleware.",
    "testFile": "src/orders/routes.test.ts",
    "sourceFile": "src/orders/routes.ts",
    "testCases": [
      "GET /api/orders/buyer — should return buyer orders for authenticated user",
      "GET /api/orders/buyer — should return 401 when not authenticated",
      "GET /api/orders/buyer — should return empty array when user has no buyer orders",
      "GET /api/orders/seller — should return seller orders for authenticated user",
      "GET /api/orders/seller — should return 401 when not authenticated",
      "GET /api/orders/seller — should return empty array when user has no seller orders",
      "GET /api/orders/combined — should return both buyer and seller orders",
      "GET /api/orders/combined — should return 401 when not authenticated",
      "GET /api/orders/combined — should return 500 when orderService throws"
    ],
    "mocksNeeded": [
      "jest.mock('../auth/routes') — authMiddleware pass-through with userId",
      "jest.mock('../services/order-service') — mock getBuyerOrders, getSellerOrders, getCombinedOrders",
      "Use supertest with Express app"
    ],
    "verification": "npm test -- --testPathPattern='orders/routes' && npm run build"
  },
  {
    "id": "T15",
    "priority": "P2",
    "category": "new-tests",
    "title": "User routes — beneficiary accounts listing",
    "description": "Create tests for src/user/routes.ts (40 LOC, zero test coverage). Single endpoint returning verified beneficiary accounts for social impact features (gift/donate flows).",
    "testFile": "src/user/routes.test.ts",
    "sourceFile": "src/user/routes.ts",
    "testCases": [
      "GET /api/beneficiary-accounts — should return verified beneficiary accounts",
      "GET /api/beneficiary-accounts — should return empty array when no beneficiaries exist",
      "GET /api/beneficiary-accounts — should only return users with vcVerified=true AND isVerifiedBeneficiary=true",
      "GET /api/beneficiary-accounts — should return id from consumptionProfile.id, fallback to utilityCustomer.did, fallback to phone",
      "GET /api/beneficiary-accounts — should include name, verified, type, and requiredEnergy fields",
      "GET /api/beneficiary-accounts — should return 500 when DB query fails",
      "GET /api/beneficiary-accounts — should not expose sensitive fields like pin or email"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "Seed users with vcVerified, isVerifiedBeneficiary, profiles, requiredEnergy",
      "Use supertest with Express app mounting userRoutes()"
    ],
    "verification": "npm test -- --testPathPattern='user/routes' && npm run build"
  },
  {
    "id": "T16",
    "priority": "P2",
    "category": "new-tests",
    "title": "Discover routes — CDS proxy with sorting and filtering",
    "description": "Create tests for src/discover/routes.ts (140 LOC, zero test coverage). Proxies discover requests to CDS, then applies client-side sorting (by price or energy) and filtering (tag=farmer). Uses Zod schema for query param validation.",
    "testFile": "src/discover/routes.test.ts",
    "sourceFile": "src/discover/routes.ts",
    "testCases": [
      "GET /api/discover — should forward discover request to CDS and return catalogs",
      "GET /api/discover — should default sourceType to SOLAR and isActive to true",
      "GET /api/discover — should sort offers by price ascending within each catalog",
      "GET /api/discover — should sort offers by price descending when order=desc",
      "GET /api/discover — should sort offers by energy quantity",
      "GET /api/discover — should sort catalogs by their best offer",
      "GET /api/discover — should filter items by tag=farmer (schema:name match)",
      "GET /api/discover — should return 500 when CDS request fails",
      "GET /api/discover — should handle empty catalogs from CDS gracefully"
    ],
    "mocksNeeded": [
      "jest.mock('axios') — mock CDS POST response with sample catalogs",
      "jest.mock('../bidding/services/market-analyzer') — mock buildDiscoverRequest",
      "Use supertest with Express app mounting discoverRoutes()"
    ],
    "verification": "npm test -- --testPathPattern='discover/routes' && npm run build"
  },
  {
    "id": "T17",
    "priority": "P2",
    "category": "new-tests",
    "title": "Bidding controller — preview and confirm bid flows",
    "description": "Create tests for src/bidding/controller.ts (109 LOC, zero test coverage). Two endpoints: previewBid validates request then calls preview(), confirmBid validates then calls confirm(). Both have input validation (provider_id, meter_id, source_type) and error handling with status code differentiation (400 for 'not found', 500 for other).",
    "testFile": "src/bidding/controller.test.ts",
    "sourceFile": "src/bidding/controller.ts",
    "testCases": [
      "previewBid — should return 400 when provider_id is missing",
      "previewBid — should return 400 when meter_id is missing",
      "previewBid — should return 400 when source_type is invalid (not SOLAR/WIND/BATTERY)",
      "previewBid — should return 200 with preview result for valid request",
      "previewBid — should return 400 when preview() throws error containing 'not found'",
      "previewBid — should return 500 for unexpected errors",
      "confirmBid — should return 400 when provider_id is missing",
      "confirmBid — should return 200 with placed_bids for valid request",
      "confirmBid — should pass max_bids param to confirm() when provided",
      "confirmBid — should return 400 when confirm() throws 'malformed' error",
      "confirmBid — should return 500 for unexpected errors"
    ],
    "mocksNeeded": [
      "jest.mock('./services/bid-optimizer') — mock preview, confirm",
      "Use mockRequest/mockResponse from test-utils or supertest with Express app"
    ],
    "verification": "npm test -- --testPathPattern='bidding/controller' && npm run build"
  },
  {
    "id": "T18",
    "priority": "P2",
    "category": "new-tests",
    "title": "Seller-bidding controller — previewSellerBid and confirmSellerBid",
    "description": "Create tests for src/seller-bidding/controller.ts (117 LOC, zero test coverage). Two authenticated endpoints that derive provider_id and meter_id from the user's generationProfile. Validates source_type, looks up user profile from DB, then delegates to hourly-optimizer preview/confirm.",
    "testFile": "src/seller-bidding/controller.test.ts",
    "sourceFile": "src/seller-bidding/controller.ts",
    "testCases": [
      "previewSellerBid — should return 400 when source_type is missing",
      "previewSellerBid — should return 400 when source_type is not SOLAR/WIND/BATTERY",
      "previewSellerBid — should return 500 when user profile not found",
      "previewSellerBid — should return 500 when user has no generationProfile",
      "previewSellerBid — should return 200 with preview result using profile-derived provider_id and meter_id",
      "confirmSellerBid — should return 400 when source_type is invalid",
      "confirmSellerBid — should return 500 when user has no generationProfile",
      "confirmSellerBid — should pass authorization token to confirm()",
      "confirmSellerBid — should return 200 with placed_bids for valid request"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "jest.mock('./services/hourly-optimizer') — mock preview, confirm",
      "Seed user with generationProfile (did, meterNumber) in users collection",
      "Use mockRequest/mockResponse with req.user = { phone: '...' }"
    ],
    "verification": "npm test -- --testPathPattern='seller-bidding/controller' && npm run build"
  },
  {
    "id": "T19",
    "priority": "P2",
    "category": "expand-tests",
    "title": "Expand trade-api — publish flow with generationProfile, forecast endpoint, published-items",
    "description": "Expand src/__tests__/api/trade-api.test.ts to cover additional trade API endpoints that were added after initial tests. The publish flow now uses simplified input (quantity, price, deliveryDate, startHour, duration, sourceType) and builds catalogs server-side from user's generationProfile. Also cover /api/forecast and /api/published-items if they exist.",
    "testFile": "src/__tests__/api/trade-api.test.ts",
    "sourceFile": "src/trade/routes.ts",
    "testCases": [
      "POST /api/publish — should return 401 when not authenticated",
      "POST /api/publish — should return 403 when user has no generationProfile",
      "POST /api/publish — should return 400 when quantity is missing",
      "POST /api/publish — should return 400 when price is missing",
      "POST /api/publish — should return 400 when deliveryDate format is invalid",
      "POST /api/publish — should store catalog, item, and offer in DB with correct beckn structure",
      "POST /api/publish — should return prosumer details from generationProfile",
      "GET /api/offers — should return all offers from offers collection",
      "GET /api/items — should return all items from items collection",
      "GET /api/inventory — should return offers with quantity projection",
      "GET /api/published-items — should return active items with matching offers for authenticated user",
      "POST /api/publish — should forward catalog to ONIX /bpp/caller/publish",
      "POST /api/publish — should handle ONIX publish failure gracefully"
    ],
    "mocksNeeded": [
      "jest.mock('../../auth/routes') — authMiddleware with valid ObjectId userId",
      "jest.mock('../../db') — standard test DB mock",
      "jest.mock('axios') — mock ONIX publish call",
      "Seed user with generationProfile (meterNumber, utilityId, consumerNumber, did, name)"
    ],
    "verification": "npm test -- --testPathPattern='api/trade-api' && npm run build"
  },
  {
    "id": "T20",
    "priority": "P3",
    "category": "new-tests",
    "title": "Voice routes — intent classification endpoint",
    "description": "Create tests for src/voice/routes.ts (92 LOC, zero test coverage). POST /api/voice/intent accepts text input, validates via Zod (min 1 char, max 50 words), calls classifyIntent LLM service, and formats response with entity types and confidence scores.",
    "testFile": "src/voice/routes.test.ts",
    "sourceFile": "src/voice/routes.ts",
    "testCases": [
      "POST /api/voice/intent — should return 400 when text field is missing",
      "POST /api/voice/intent — should return 400 when text exceeds 50 word limit",
      "POST /api/voice/intent — should return 400 when text is empty string",
      "POST /api/voice/intent — should return classified intent with confidence and entities",
      "POST /api/voice/intent — should set low_confidence=true when confidence < 0.5",
      "POST /api/voice/intent — should return 503 when LLM service throws",
      "POST /api/voice/intent — should map entity names to ENTITY_TYPES units"
    ],
    "mocksNeeded": [
      "jest.mock('./intent-service') — mock classifyIntent",
      "jest.mock('./entities') — mock ENTITY_TYPES constant",
      "Use supertest with Express app mounting voiceRoutes()"
    ],
    "verification": "npm test -- --testPathPattern='voice/routes' && npm run build"
  },
  {
    "id": "T21",
    "priority": "P3",
    "category": "new-tests",
    "title": "Energy-request controller — createEnergyRequest, getEnergyRequests, findBestSeller, giftEnergy, donateEnergy",
    "description": "Create tests for src/energy-request/controller.ts (385 LOC, zero test coverage). Handles the social impact feature: beneficiaries create energy requests, sellers can donate (price=0) or buyers can gift (discover + buy + pay). Complex multi-step flows with DB operations and external API calls (discover via CDS).",
    "testFile": "src/energy-request/controller.test.ts",
    "sourceFile": "src/energy-request/controller.ts",
    "testCases": [
      "createEnergyRequest — should return 401 when not authenticated",
      "createEnergyRequest — should return 400 when requiredEnergy is missing",
      "createEnergyRequest — should return 400 when purpose is missing",
      "createEnergyRequest — should return 404 when user profile not found",
      "createEnergyRequest — should insert request with PENDING status and return 201",
      "createEnergyRequest — should include isVerifiedBeneficiary from user profile",
      "getEnergyRequests — should return all PENDING requests sorted by createdAt desc",
      "getEnergyRequests — should return empty array when no pending requests",
      "findBestSeller — should return 400 when requestId is missing",
      "findBestSeller — should return 400 for invalid ObjectId format",
      "findBestSeller — should return 404 when energy request not found",
      "findBestSeller — should return 404 when no catalogs from CDS",
      "findBestSeller — should return cheapest offer sorted by price ascending",
      "findBestSeller — should match item to offer via beckn:items reference",
      "giftEnergy — should return 401 when not authenticated",
      "giftEnergy — should return 400 when requestId is missing",
      "giftEnergy — should return 404 when request not found",
      "giftEnergy — should return 400 when request already FULFILLED",
      "giftEnergy — should call executeDirectTransaction with autoConfirm=false",
      "giftEnergy — should update request status to PAYMENT_PENDING",
      "donateEnergy — should return 401 when not authenticated",
      "donateEnergy — should return 404 when seller profile not found",
      "donateEnergy — should call executeDirectTransaction with price=0",
      "donateEnergy — should update request status to FULFILLED"
    ],
    "mocksNeeded": [
      "jest.mock('../db') — standard test DB mock",
      "jest.mock('./service') — mock executeDirectTransaction, discoverBestSeller",
      "jest.mock('axios') — mock CDS discover calls for findBestSeller",
      "jest.mock('../bidding/services/market-analyzer') — mock buildDiscoverRequest",
      "Use mockRequest/mockResponse with req.user and req.headers.authorization",
      "Seed users with phone, isVerifiedBeneficiary, profiles",
      "Seed energy_requests collection with sample requests"
    ],
    "verification": "npm test -- --testPathPattern='energy-request/controller' && npm run build"
  },
  {
    "id": "T22",
    "priority": "P3",
    "category": "new-tests",
    "title": "Energy-request service — executeDirectTransaction and discoverBestSeller",
    "description": "Create tests for src/energy-request/service.ts (371 LOC, zero test coverage). executeDirectTransaction orchestrates a full beckn flow: publish → select → init → confirm (or stop at init for gifts). discoverBestSeller queries CDS and returns cheapest offer. Heavy axios mocking required.",
    "testFile": "src/energy-request/service.test.ts",
    "sourceFile": "src/energy-request/service.ts",
    "testCases": [
      "executeDirectTransaction — should call publish, select, init, confirm in sequence",
      "executeDirectTransaction — should use simplified publish format (quantity, price, deliveryDate, startHour)",
      "executeDirectTransaction — should stop at init when autoConfirm=false (gift flow)",
      "executeDirectTransaction — should return INITIATED status when autoConfirm=false",
      "executeDirectTransaction — should return CONFIRMED status when autoConfirm=true",
      "executeDirectTransaction — should use price=0.01 instead of 0 for donations (minimum)",
      "executeDirectTransaction — should include beneficiaryId in select payload buyer attributes",
      "executeDirectTransaction — should propagate publish errors",
      "executeDirectTransaction — should propagate select errors",
      "discoverBestSeller — should return cheapest offer from CDS catalogs",
      "discoverBestSeller — should return null when no catalogs found",
      "discoverBestSeller — should return null when CDS request fails"
    ],
    "mocksNeeded": [
      "jest.mock('axios') — mock sequential POST calls for publish, select, init, confirm, and discover",
      "Set process.env.BAP_ID and process.env.BAP_URI before import",
      "Mock crypto.randomUUID for deterministic transaction IDs in assertions"
    ],
    "verification": "npm test -- --testPathPattern='energy-request/service' && npm run build"
  }
]
